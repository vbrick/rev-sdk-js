<!DOCTYPE html>

<html>
	<head>
		<style>
			#embed {
				height: 600px;
				margin: 20px;
			}

			form > div, form > button {
				margin: 10px 20px;
			}
		</style>
	</head>
	<body>
		<div id="embed"></div>

		<div>
			<form>
				<div>
					<label for="webcastId">Webcast Id:</label>
					<input type="text" id="webcastId" name="webcastId">
				</div>
				<div>
					<label for="jwtToken">JWT Token:</label>
					<input type="text" id="jwtToken" name="jwtToken">
				</div>
				<div>
					<label for="baseUrl">Rev URL:</label>
					<input type="text" id="baseUrl" name="baseUrl">
				</div>
				<button type="submit">Reload</button>
			</form>
			<h5>Webcast Status:</h5> <span id="status"></span></b>

			<h5>Messages</h5>
			<ul id="logMessages"> </ul>
		</div>

		<script src="/dist/rev-sdk.js"> </script>
		<script>
			console.log('Demo, API: ', window.revSdk);

			const queryParams = getQueryParams();
			const webcastId = getParameterByName('webcastId');
			const jwtToken = getParameterByName('jwtToken');
			const baseUrl = getParameterByName('baseUrl');

			const token = {
				type: 'JWT',
				issuer: 'vbrick_rev',
				value: jwtToken
			};

			console.log({ webcastId, jwtToken, baseUrl });

			document.getElementById('webcastId').value = webcastId;
			document.getElementById('jwtToken').value = jwtToken;
			document.getElementById('baseUrl').value = baseUrl;
			document.querySelector('form').addEventListener('submit', reload);

			function reload(e) {
				e.preventDefault();
				setCookie('webcastId', document.getElementById('webcastId').value);
				setCookie('jwtToken', document.getElementById('jwtToken').value);
				setCookie('baseUrl', document.getElementById('baseUrl').value);
				window.location.search = "";
			}

			const webcast = revEmbed.embedWebcast('#embed', webcastId, {
				showVideo: true,
				log: true,
				token,
				baseUrl
			});

			const statusEl = document.getElementById('status');
			const logEl = document.getElementById('logMessages');


			['error', 'load', 'webcastLoaded', 'webcastStarted', 'broadcastStarted', 'broadcastStopped', 'webcastEnded']
				.forEach(e => webcast.on(e, data => {
					const li = document.createElement('li');
					li.innerHTML = `${new Date().toLocaleTimeString()} ${event}:${stringifyJson(data)}`;
					logEl.appendChild(li);
				}));

			window.setInterval(() => statusEl.innerHTML = webcast.status || 'undefined', 1000);

			function setCookie(cookie, value) {
				document.cookie = cookie + '=' + encodeURIComponent(value);
			}

			function getCookie(name) {
				let value = '; ' + document.cookie;
				let parts = value.split('; '+name + '=');
				if (parts.length === 2) {
					return decodeURIComponent(parts.pop().split(';').shift());
				}
			}

			function getQueryParams() {
				const query = window.location.search.substring(1);
				if(!query) {
					return {};
				}

				return query.split('&')
					.reduce((result, paramStr) => {
						const [key, value] = paramStr.split('=').map(decodeURIComponent);
						result[key] = value;
						return result
					}, {});
			}

			function getParameterByName(name) {
				return queryParams[name] || getCookie(name) || '';
			}

			function stringifyJson(data) {
				if (!data) {
					return '';
				}
				return JSON.stringify(data, replaceErrors);
			}

			function stringifyJson(data) {
				if (!data) {
					return '';
				}
				return JSON.stringify(data, (key, value) => value instanceof Error
					? e.toString() + '\n' + e.stack.toString()
					: value
				);
			}

		</script>
	</body>
</html>
